@page "/place-order"
@using Ordering_Adlawan_IT13.Models
@using Ordering_Adlawan_IT13.Services
@inject OrderingService OrderingService

<style>
  .place-order-page {
        padding: 30px;
    }

    .page-title {
        font-size: 28px;
 font-weight: 700;
        margin-bottom: 30px;
    color: #1e293b;
    }

    .order-container {
        display: grid;
  grid-template-columns: 400px 1fr;
    gap: 30px;
    }

    .order-form-card {
        background: white;
     border-radius: 12px;
 padding: 28px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
border: 1px solid #e2e8f0;
        height: fit-content;
        position: sticky;
        top: 20px;
    }

    .form-title {
   font-size: 18px;
      font-weight: 700;
     margin-bottom: 24px;
   color: #1e293b;
 }

    .form-group {
     display: flex;
    flex-direction: column;
  margin-bottom: 18px;
    }

    .form-group label {
        font-size: 14px;
        font-weight: 600;
     margin-bottom: 8px;
        color: #1e293b;
}

 .form-control, select, textarea {
        padding: 11px 14px;
     border: 1px solid #e2e8f0;
   border-radius: 8px;
        font-size: 14px;
 font-family: inherit;
     transition: all 0.3s ease;
        background: white;
 }

    .form-control:focus, select:focus, textarea:focus {
        border-color: #6366f1;
   box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235b21b6' d='M1 3l5 5 5-5'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 32px;
        cursor: pointer;
    }

    textarea {
     resize: vertical;
        min-height: 90px;
    }

 .price-display {
        background: linear-gradient(135deg, #e0e7ff 0%, #f5e7ff 100%;
        border: 2px solid #6366f1;
   border-radius: 8px;
  padding: 12px 14px;
    font-size: 16px;
   font-weight: 700;
     color: #6366f1;
        text-align: right;
    }

    .submit-btn {
     width: 100%;
    padding: 14px 20px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%;
   color: white;
  font-size: 16px;
     font-weight: 700;
    cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 24px;
     box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .submit-btn:hover {
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5);
 transform: translateY(-2px);
    }

    .message {
      margin-top: 16px;
        padding: 14px 16px;
        border-radius: 8px;
      border-left: 4px solid;
        font-size: 14px;
        animation: slideInMsg 0.3s ease;
  }

 .message-success {
        background-color: #dcfce7;
     color: #166534;
        border-left-color: #10b981;
    }

    .message-error {
 background-color: #fee2e2;
        color: #991b1b;
   border-left-color: #ef4444;
    }

    .recent-orders-card {
        background: white;
     border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .card-header {
        font-size: 18px;
  font-weight: 700;
  padding: 24px;
 color: #1e293b;
  border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .table {
     width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .table thead {
 background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 2px solid #e2e8f0;
    }

    .table th {
        padding: 14px;
   font-weight: 600;
        font-size: 13px;
   text-align: left;
     color: #64748b;
  text-transform: uppercase;
letter-spacing: 0.5px;
    }

    .table td {
    padding: 14px;
    border-bottom: 1px solid #e2e8f0;
font-size: 14px;
    }

   .table tbody tr:hover {
 background-color: #f8fafc;
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

 .status-badge {
        display: inline-block;
     padding: 6px 12px;
     border-radius: 20px;
        font-size: 12px;
  font-weight: 600;
    }

    .status-pending {
        background-color: #fef3c7;
      color: #92400e;
    }

    .status-completed {
     background-color: #dcfce7;
      color: #166534;
    }

  .status-cancelled {
        background-color: #fee2e2;
    color: #991b1b;
    }

  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: #64748b;
    }

    .empty-state-icon {
 font-size: 48px;
   margin-bottom: 12px;
    }
</style>

<div class="place-order-page">
 <h1 class="page-title">🧾 Place New Order</h1>

    <div class="order-container">
  <!-- Order Form -->
<div class="order-form-card">
   <h3 class="form-title">📝 Order Details</h3>

       <div class="form-group">
     <label>Customer Name *</label>
        <input class="form-control" @bind="customerName" placeholder="Enter customer name" />
    </div>

   <div class="form-group">
       <label>Food Item *</label>
       <select class="form-control" @onchange="e => OnItemChanged(e)" value="@selectedItemId">
        <option value="">-- Select Item --</option>
  @foreach (var item in items)
     {
       <option value="@item.ItemId">@item.ItemName - ₱@item.Price.ToString("N2") (@item.Quantity available)</option>
          }
 </select>
            </div>

      <div class="form-group">
<label>Unit Price</label>
      <input class="form-control price-display" value="₱@unitPrice.ToString("N2")" disabled />
            </div>

    <div class="form-group">
 <label>Quantity *</label>
      <input type="number" class="form-control" @bind="quantity" @bind:after="OnQuantityChanged" min="1" />
    </div>

  <div class="form-group">
       <label>Total Price</label>
     <input class="form-control price-display" value="₱@totalPrice.ToString("N2")" disabled />
            </div>

            <div class="form-group">
        <label>Special Instructions</label>
  <textarea class="form-control" @bind="notes" placeholder="Add any special requests..."></textarea>
        </div>

      <button class="submit-btn" @onclick="SaveOrder">✅ Submit Order</button>

   @if (!string.IsNullOrEmpty(message))
            {
     <div class="message @(message.Contains("Error") || message.Contains("⚠️") ? "message-error" : "message-success")">
             @message
         </div>
 }
        </div>

<!-- Recent Orders -->
        <div class="recent-orders-card">
  <div class="card-header">📊 Recent Orders (Latest 10)</div>

@if (recentOrders == null)
   {
        <div class="empty-state">
   <div class="empty-state-icon">⏳</div>
     <p>Loading orders...</p>
    </div>
  }
    else if (!recentOrders.Any())
    {
          <div class="empty-state">
   <div class="empty-state-icon">📭</div>
    <p>No orders yet. Place your first order!</p>
        </div>
            }
else
            {
       <table class="table">
       <thead>
     <tr>
 <th>Order ID</th>
    <th>Customer</th>
        <th>Item</th>
   <th>Qty</th>
    <th>Total</th>
         <th>Status</th>
    </tr>
      </thead>
        <tbody>
      @foreach (var o in recentOrders)
         {
             <tr>
   <td><strong>#@o.OrderId</strong></td>
   <td>@o.CustomerName</td>
        <td>@o.ItemName</td>
 <td>@o.OrderQuantity</td>
    <td><strong>₱@o.TotalPrice.ToString("N2")</strong></td>
          <td>
   <span class="status-badge @(o.Status == "Pending" ? "status-pending" : o.Status == "Completed" ? "status-completed" : "status-cancelled")">
       @o.Status
           </span>
  </td>
       </tr>
     }
     </tbody>
        </table>
          }
        </div>
    </div>
</div>

@code {
    private List<FoodItem> items = new();
    private List<Order>? recentOrders;

    private string? customerName;
    private string? selectedItemId;
    private decimal unitPrice;
    private int quantity = 1;
  private decimal totalPrice;
    private string? notes;
    private string? message;

    protected override async Task OnInitializedAsync()
    {
        try
   {
      items = await OrderingService.GetFoodItemsAsync();
            recentOrders = (await OrderingService.GetOrdersAsync()).Take(10).ToList();
        }
      catch (Exception ex)
        {
        Console.WriteLine($"Error loading data: {ex.Message}");
        }
}

    private void OnItemChanged(ChangeEventArgs e)
    {
selectedItemId = e.Value?.ToString();
        var item = items.FirstOrDefault(i => i.ItemId.ToString() == selectedItemId);
      unitPrice = item?.Price ?? 0;
        ComputeTotal();
    }

 private Task OnQuantityChanged()
    {
        if (quantity < 1) quantity = 1;
        ComputeTotal();
return Task.CompletedTask;
    }

    private void ComputeTotal() => totalPrice = unitPrice * quantity;

    private async Task SaveOrder()
    {
 if (string.IsNullOrWhiteSpace(customerName) || string.IsNullOrEmpty(selectedItemId))
  {
   message = "❌ Please enter customer name and select an item.";
            return;
        }

    try
    {
        var item = items.First(i => i.ItemId.ToString() == selectedItemId);

      var order = new Order
    {
           CustomerName = customerName!,
     ItemId = item.ItemId,
         ItemName = item.ItemName,
       OrderQuantity = quantity,
    UnitPrice = unitPrice,
    TotalPrice = totalPrice,
    Status = "Pending",
              OrderDate = DateTime.Now,
    Notes = notes
   };

    await OrderingService.AddOrderAsync(order);
          message = "✅ Order placed successfully!";

     recentOrders = (await OrderingService.GetOrdersAsync()).Take(10).ToList();
customerName = null;
            selectedItemId = null;
  unitPrice = 0;
     quantity = 1;
  totalPrice = 0;
notes = null;

    _ = Task.Delay(3000).ContinueWith(_ => message = null);
 }
 catch (InvalidOperationException ex)
      {
 message = $"⚠️ {ex.Message}";
            Console.WriteLine($"Validation Error: {ex.Message}");
      }
     catch (Exception ex)
   {
    message = $"❌ Error placing order: {ex.Message}";
       Console.WriteLine($"Error: {ex.Message}");
        }
    }
}
