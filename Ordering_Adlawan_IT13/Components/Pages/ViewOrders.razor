@page "/view-orders"
@using Ordering_Adlawan_IT13.Models
@using Ordering_Adlawan_IT13.Services
@inject OrderingService OrderingService
@inject IJSRuntime JS

<style>
    .view-orders-page {
        padding: 30px;
  }

    .page-title {
        font-size: 28px;
        font-weight: 700;
   margin-bottom: 24px;
        color: #1e293b;
    }

    .controls-section {
     background: white;
   border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
 gap: 16px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
gap: 12px;
    }

    .filter-label {
        font-weight: 600;
        color: #1e293b;
        font-size: 14px;
    }

    .filter-select {
      padding: 10px 14px;
        border: 1px solid #e2e8f0;
      border-radius: 8px;
        font-size: 14px;
     font-family: inherit;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235b21b6' d='M1 3l5 5 5-5'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
   background-position: right 10px center;
 padding-right: 32px;
        background-color: white;
    }

    .filter-select:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .orders-table-card {
        background: white;
     border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
   overflow: auto;
width: 100%;
    }

    .table {
    width: 100%;
        border-collapse: collapse;
        background: white;
 min-width: 1000px;
    }

    .table thead {
   background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 2px solid #e2e8f0;
    }

    .table th {
        padding: 16px;
        font-weight: 600;
      font-size: 13px;
   text-align: left;
        color: #64748b;
        text-transform: uppercase;
  letter-spacing: 0.5px;
    }

    .table td {
padding: 16px;
    border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
        color: #1e293b;
    }

    .table tbody tr {
        transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f8fafc;
}

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .order-id {
        font-weight: 700;
        color: #6366f1;
    }

    .order-date {
        color: #64748b;
        font-size: 13px;
}

    .status-select {
      padding: 8px 10px;
    border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
  cursor: pointer;
   transition: all 0.2s ease;
        min-width: 140px;
        appearance: none;
 background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%235b21b6' d='M1 3l5 5 5-5'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
     background-position: right 8px center;
        padding-right: 28px;
     background-color: white;
      width: 100%;
   max-width: 140px;
    }

    .status-select:focus {
        border-color: #6366f1;
        outline: none;
    }

    .status-pending {
    background-color: #fef3c7;
        color: #92400e;
        border-color: #fcd34d;
    }

    .status-completed {
   background-color: #dcfce7;
     color: #166534;
        border-color: #bbf7d0;
    }

    .status-cancelled {
     background-color: #fee2e2;
  color: #991b1b;
   border-color: #fecaca;
  }

    .notes-cell {
        color: #64748b;
        font-size: 13px;
      max-width: 150px;
        white-space: nowrap;
    overflow: hidden;
     text-overflow: ellipsis;
    }

    .btn-delete {
        padding: 8px 14px;
  border: 1px solid #fee2e2;
        background: white;
  color: #ef4444;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
    }

    .btn-delete:hover {
     background: #fee2e2;
        border-color: #ef4444;
    }

    .empty-state {
        text-align: center;
        padding: 64px 24px;
        color: #64748b;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .empty-state h3 {
        font-size: 18px;
      font-weight: 600;
   color: #1e293b;
        margin-bottom: 8px;
    }

    .stats-row {
        display: grid;
     grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
  margin-left: auto;
    }

    .stat-badge {
      background: linear-gradient(135deg, #e0e7ff 0%, #f5e7ff 100%);
        padding: 8px 16px;
border-radius: 8px;
        font-size: 13px;
  font-weight: 600;
        color: #6366f1;
    }

    .loading-indicator {
     text-align: center;
      padding: 48px;
        color: #64748b;
  }

    .loading-spinner {
   font-size: 32px;
    }
</style>

<div class="view-orders-page">
    <h1 class="page-title">?? View Orders</h1>

    <div class="controls-section">
        <div class="filter-group">
            <label class="filter-label">?? Filter by Status:</label>
<select class="filter-select" value="@filterStatus" @onchange="e => FilterChanged(e)">
        <option value="">?? All Orders</option>
   <option value="Pending">? Pending</option>
          <option value="Completed">? Completed</option>
        <option value="Cancelled">? Cancelled</option>
       </select>
        </div>

        <div class="stats-row">
        <div class="stat-badge">
      ?? Total: @(allOrders?.Count ?? 0)
        </div>
            <div class="stat-badge">
       ? Pending: @(allOrders?.Count(o => o.Status == "Pending") ?? 0)
      </div>
        <div class="stat-badge">
          ? Completed: @(allOrders?.Count(o => o.Status == "Completed") ?? 0)
 </div>
        </div>
    </div>

    <div class="orders-table-card">
    @if (orders == null)
        {
            <div class="loading-indicator">
    <div class="loading-spinner">?</div>
          <p style="margin-top: 16px;">Loading orders...</p>
        </div>
        }
        else if (!orders.Any())
     {
         <div class="empty-state">
      <div class="empty-state-icon">??</div>
<h3>No Orders Found</h3>
        <p>No orders match your filter criteria. <a href="/place-order" style="color: #6366f1; font-weight: 600;">Place an order now</a></p>
            </div>
        }
        else
      {
          <table class="table">
           <thead>
        <tr>
  <th style="width: 50px;">Order ID</th>
    <th style="width: 140px;">Date & Time</th>
       <th style="width: 100px;">Customer</th>
  <th style="width: 100px;">Item</th>
       <th style="width: 50px; text-align: center;">Qty</th>
           <th style="width: 90px; text-align: right;">Total</th>
      <th style="width: 150px; text-align: center;">Status</th>
            <th style="width: 120px;">Notes</th>
       <th style="width: 100px; text-align: center;">Action</th>
    </tr>
       </thead>
  <tbody>
@foreach (var o in orders)
          {
 <tr>
           <td><span class="order-id">#@o.OrderId</span></td>
        <td><span class="order-date">@o.OrderDate.ToString("MMM dd, yyyy HH:mm")</span></td>
              <td><strong>@o.CustomerName</strong></td>
          <td>@o.ItemName</td>
            <td style="text-align: center;"><strong>@o.OrderQuantity</strong></td>
                 <td style="text-align: right;"><strong>?@o.TotalPrice.ToString("N2")</strong></td>
       <td style="text-align: center;">
      <select class="status-select @("Pending" == o.Status ? "status-pending" : "Completed" == o.Status ? "status-completed" : "status-cancelled")"
              @onchange="e => ChangeStatus(o, e)">
    <option selected="@("Pending" == o.Status)" value="Pending">? Pending</option>
          <option selected="@("Completed" == o.Status)" value="Completed">? Completed</option>
   <option selected="@("Cancelled" == o.Status)" value="Cancelled">? Cancelled</option>
         </select>
  </td>
             <td><span class="notes-cell" title="@(o.Notes ?? "No notes")">@(o.Notes ?? "—")</span></td>
        <td style="text-align: center;">
              <button class="btn-delete" @onclick="() => DeleteOrder(o.OrderId)" title="Delete this order">
    ??? Delete
      </button>
       </td>
       </tr>
          }
         </tbody>
       </table>
        }
    </div>
</div>

@code {
    private List<Order>? allOrders;
private List<Order>? orders;
    private string? filterStatus = "";

  protected override async Task OnInitializedAsync()
    {
        try
 {
        await LoadOrders();
 }
        catch (Exception ex)
        {
       Console.WriteLine($"Error loading orders: {ex.Message}");
        }
    }

    private async Task LoadOrders()
    {
        allOrders = await OrderingService.GetOrdersAsync();
     ApplyFilter();
    }

    private void ApplyFilter()
    {
     if (string.IsNullOrEmpty(filterStatus))
          orders = allOrders;
        else
   orders = allOrders?.Where(o => o.Status == filterStatus).ToList();
    }

    private void FilterChanged(ChangeEventArgs e)
    {
     filterStatus = e.Value?.ToString();
        ApplyFilter();
    }

    private async Task ChangeStatus(Order order, ChangeEventArgs e)
    {
        var newStatus = e.Value?.ToString() ?? order.Status;
   if (newStatus == order.Status) return;

        var oldStatus = order.Status;
        order.Status = newStatus;
 try
        {
            await OrderingService.UpdateOrderStatusAsync(order.OrderId, newStatus);
        }
        catch (Exception ex)
     {
            Console.WriteLine($"Error updating status: {ex.Message}");
            order.Status = oldStatus;
        }
}

    private async Task DeleteOrder(int id)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this order?");
if (!ok) return;

    try
      {
     await OrderingService.DeleteOrderAsync(id);
   await LoadOrders();
        }
   catch (Exception ex)
        {
        Console.WriteLine($"Error deleting order: {ex.Message}");
     }
    }
}
